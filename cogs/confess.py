"""
if you see an insane mess here, it's supposed to be zoidberg. Probably only works correcly in certain fonts,
sublime with Ayu doesn't work, for instance.

▌▙▚▛▞▚▚▘▌▚▝▄▙▜▜▀▀▙▌▜▟▌▚▌▌▌▚▚▚▚▚▚▚▚▚▚▚▘▌▚▀▖▚▝▖▚▝▖▚▝▖▚▝▖▚▝▖▚▝▖
▚▀▄▘▀▖▚▙▞█▛▜▐▐▝▞▞▟▜▐▟▐▚▚▐▐▐▗▚▐▗▚▐▗▚▐▗▚▚▚▚▜▝▞▝▖▌▞▖▌▞▖▚▐▗▚▝▖▚
▚▚▐▞▙█▜▐▚▘▞▖▚▗▚▝▖▛▙▐▟▀▖▌▚▐▝▞▞▐▝▞▞▐▝▞▞▞▐▗▚▐▐▞▐▗▘▞▗▝▖▞▝▖▚▗▚▐▝▖
▟▜▚▜▝▖▚▖▘▙▐▐▝▖▚▚▝▛▞▞▙▚▚▚▚▚▚▚▐▐▐▝▞▞▞▞▖▌▌▌▌▌▚▐▗▘▞▝▞▝▞▝▞▝▖▚▗▘▞
▐▝▞▖▌▌▌▀▌▞▞▙▘▌▚▗▚▛▙▜▟▜▐▝▞▖▌▚▚▚▚▚▚▐▝▖▌▚▐▝▖▌▌▌▌▚▐▝▖▌▞▝▞▝▞▖▚▝▝▖
▞▞▞▞▞▞▞▚▚▚▚▚▚▐▝▖▘▛▌▟▟▝▄▚▚▚▚▚▚▐▗▚▘▌▌▌▌▌▌▌▌▌▚▚▀▖▚▝▖▞▝▞▗▚▗▝▖▌▌▖
▚▚▚▌▙▛▟▙▚▚▚▜▗▘▚▐▝▛▙▐▟▚▚▚▐▗▚▚▐▝▞▖▌▌▞▞▐▝▞▐▝▞▞▖▌▛▖▌▚▝▞▝▖▚▝▞▖▞▗
▛▛▙█▙▛█▞▞▖▌▛▖▌▚▘▚▜▌▚█▗▀▞▐▝▖▌▘▘▘▘▚▚▚▐▐▐▐▐▐▝▖▌▌▌▚▝▖▌▞▐▝▖▌▄▝▖▚▘
▛█▙▙▙▛▙▌▌▌█▚▝▐▗▘▌▙▛▞▙▚▚▞▞▞▞▖▖     ▝▝▐▗▚▐ ▘▀   ▚▚▘▞▝▖▚▝▖▖▚▐▗▘
▛▙▙▙▙▛▙▌▌▜▝▖▀▖▘▌▞▞▙▜▐▚▖▙▘▌▚▘  ▖▜▘▗   ▞▞▘   ▙   ▌▚▝▞▝▖▌▞▝▖▚▗▘
█▙▜▟▚▛▙▌▌█▝▞▞▐▝▖▚▛▞▟▌▛▛▌▌▌▌▙       ▝ ▌▞▖ ▝   ▝▗▝▖▌▞▐▗▝▖▌▚▘▖▘
▙▜▜▟▜▜▙▛▞▟▝▖▞▖▛▟█▜▙▚▛▞▘▌▌▞▞▖▌▖▗ ▘ ▘▗▞▐▐▐▗  ▖▝▗▖▚▘▞▝▖▚▚▝▖▚▝▞▖    __________ _____ _____  ____  ______ _____   _____
▛█▜▟▛█▟▞▞▟▐▝▖▚▌▀▝▀▝▀▞  ▞▞▞▖▌▌▚▚▗▖▖▜▐▐▝▖▌▌▌▄▗▀▌▞▖▚▝▞▝▖▖▌▞▖▚▗    |___  / __ \_   _|  __ \|  _ \|  ____|  __ \ / ____|
▛▙▛▙▛▙▙▌▙▀▝           ▐▝▖▌▚▐▐▝▛▀▚▀▞▖▌▌▌▌▞▞▞▞▚▚▗▘▚▚▝▞▝▖▞▗▝▞▝▖      / / |  | || | | |  | | |_) | |__  | |__) | |  __
▛▛▛▙▛▌▘▘              ▞▞▞▞▞▞▖▙▙▛▞▞▞▐▝▞▐▝▞▖▌▞▚▘▘▘▙▗▚▐▝▞▞▖▌▞▝▖     / /| |  | || | | |  | |  _ <|  __| |  _  /| | |_ |
█▜▛▌▘     ▝▗         ▗▚▚▐▝▞▄████▞▖▌▌▌▌▌▜▝▞▝▌▌▌▌▗▗▐▐▗▚▚▐▝▞▝▌▀    / /_| |__| || |_| |__| | |_) | |____| | \ \| |__| |
▛▌▘     ▄▗▐▀▞▚▀▞▚▀▞▖ ▗▚▚▚▚▜█████▞▞▐▝▙▐▐▝▙▚▚▚▚▐ ▌▚▌▌▚▚▘▌▚▚▚▚▘   /_____\____/_____|_____/|____/|______|_|  \_\\_____|
▘   ▗▖▜▐▝▞▖▌▌▌▌▌▌▌▘  ▘▖▐▗▚▛█▜██▛▖▌▌▌▌▞▖▙▚▘▌▚▚▚▘▌    ▘▌▌▌▚▘▌▘
  ▗▞▚▐▐▝▞▞▞▞▐▝▞▐     ▗▝ ▚▚▝▌▛▞▟▐▐▝▖▌▌▚▚▞▖▌▌▌▌▞▖      ▘▌▞▞▞▞▖
▗▞▚▚▚▚▘▌▌▞▖▌▌▌▀      ▝▗▘▖▚▚▚▐▝▖▌▚▚▜▞▞▞▞▞▞▞▐▝▞▐▐▝       ▝▝▞▐
▞▐▝▖▌▚▚▘▌▚▚▚▐▗        ▚▗▝▗▝▝▟▐▐▐▝▌▜▗▚▐▝▞▐▝▞ ▘▘           ▄▚▘
▐▐▐▐▐▐▗▚▚▚▚▐▐▘        ▝▞▗▖▝▖▗▗▗▗▚▝▗▝▐ ▛  ▝      ▌         ▘▌
▚▘▌▚▘▌▚▚▘▌▞▞         ▖ ▝▗▝▘▄▘▗▗ ▖▝▗▐▖▀          ▌
▞▞▞▞▞▞▞▖▌▌▌▖▝            ▞▗ ▞ ▚▀▀▘▘▖            ▌   ▝  ▖
▐▝▞▐▝▞▐▐▝▞▞ ▖      ▝     ▝▖▝▗▝▗▝▗▘▘             ▘
▚▚▚▚▚▚▚▘▌▘       ▞▜        ▘▖▐ ▝               ▗  ▗▄▖
▞▖▌▚▐▗▚▚▘  ▝   ▄▜▐▝      ▗ ▝                 ▖▘▝   ▗▚▀▚▗▄▖▗
▐▐▐▐▐▐▗▚▘  ▖ ▄▜▝▖▌▘  ▗ ▝                    ▘       ▗▚▚▚▝▞▞▖
▘▘▝▝ ▘▌   ▗ ▘▘▝▝▝▝ ▘                 ▘   ▘     ▘     ▘▌▘▘▘▝
"""
# This software is provided free of charge without a warranty - meaning if you're an idiot and somehow
# blow up your sever, I am not liable or responsible.
# This Source Code Form is subject to the terms of the Mozilla Public
# License, v. 2.0. If a copy of the MPL was not distributed with this
# file, You can obtain one at https://mozilla.org/MPL/2.0/.

# This is designed as a component for confbot. Use outside of that is not supported.
# Do not create an issue on the repo if this is used outside of the main bot. If you create one, it will be closed.
import asyncio
from datetime import datetime
from io import BytesIO
import re

import discord
from discord.ext import commands

from bot import bot
from zoidbergbot.localization import get_string
from zoidbergbot.verify import verify_user
from zoidbergbot.config import *


def find_url(input):
    regex = r"(?i)\b((?:https?://|www\d{0,3}[.]|[a-z0-9.\-]+[.][a-z]{2,4}/)(?:[^\s()<>]+|\(([^\s()<>]+|(\([^\s(" \
            r")<>]+\)))*\))+(?:\(([^\s()<>]+|(\([^\s()<>]+\)))*\)|[^\s`!()\[\]{};:'\".,<>?«»“”‘’])) "
    return re.search(input, regex)


class Confess(commands.Cog):
    """Cog for confessing. As the name makes clear. """

    def __init__(self, bot):
        self.bot = bot

    @commands.command(name="conf")
    async def cmd_conf(self, ctx, *, message=""):
        # Checks if the message actually contains anything worth sending.
        if (len(message) != 0) or (ctx.message.attachments != []):
            current_time = datetime.now().strftime("%d/%m %H:%M")

            # Obtains User ID and nickname to verify user is in guild/server
            user_id = ctx.message.author.id
            server = bot.get_guild(GUILD_ID)
            # Assigns Discord channel (given channel ID)
            print(CHANNEL_ID)
            print(LOG_ID)
            channel = bot.get_channel(int(CHANNEL_ID))
            logChannel = bot.get_channel(int(LOG_ID))
            # last_message_id = ctx.channel.last_message_id

            # TODO: reformat this and add better logging options.
            print(current_time, file=open("../output.txt", "a"))
            print(user_id, file=open("../output.txt", "a"))
            print("Guild ID:", GUILD_ID)
            print(server, file=open("../output.txt", "a"))
            print("Channel:", CHANNEL_ID, channel, file=open("../output.txt", "a"))
            print("Log:", LOG_ID, file=open("../output.txt", "a"))
            print(str(ctx.message.author).encode("utf-8"), file=open("../output.txt", "a"))
            print(ctx.message.content)

            if get_user_ban(user_id):
                await ctx.send(
                    "You have been temporarily blacklisted from sending confessions. \nThis could be a "
                    "permanent ban, or simply rate limiting. ")
                pass
            # Create embed. They're fancy
            embed = discord.Embed(description=f"{message}\n\n:id:: \n:card_box::")
            print(message, file=open("../output.txt", "a"))
            embed.set_footer(text=f"Pulling info. ")
            # Send embed.
            msg = await channel.send(embed=embed)
            embed = discord.Embed(
                description=f"{message}  \n\n:id:: {msg.id}")
            files = []
            for file in ctx.message.attachments:
                fp = BytesIO()
                await file.save(fp)
                files.append(discord.File(fp, filename=file.filename, spoiler=file.is_spoiler()))
                imageURL = ctx.message.attachments[0].url
                embed.set_image(url=imageURL)
                print("image" + imageURL)
            url = find_url(message)
            if url is not None:
                imageURL = url
            await asyncio.sleep(3)
            embed.set_footer(text=f"{current_time}")
            await msg.edit(embed=embed)

            # log message
            embed.set_footer(text="%s %s\n%s" % (current_time, str(user_id + 10), ctx.message.author))
            await logChannel.send(embed=embed)
            # Inform user their message has been sent
            await ctx.send("Your message has been sent!")

        # If the message contains no image or text
        else:
            await ctx.send("Your message does not contain any content. Message failed.")
        print("--------------------------------------- END CONFESS ---------------------------------------",
              file=open("../output.txt", "a"))

    @cmd_conf.error
    async def conf_error(self, ctx, error):
        if isinstance(error, commands.CommandOnCooldown):
            await ctx.send('Please wait before sending ')
        if isinstance(error, commands.MissingPermissions):
            await ctx.send('You do not have manage_messages permission')

    @commands.command(name="announcement")
    async def cmd_conf_announcement(self, ctx, message):
        channel = bot.get_channel(int(CHANNEL_ID))
        if verify_user(ctx, "admin"):
            embed = discord.Embed(body=ctx.message, color=0xFF5733, title="Confession Announcement",
                                  footer=f"confessbot v{get_string('VERSION')}.")
            await ctx.send(embed=embed)

            async def confirm(m):
                await ctx.send('Please reply "Confirm" to send the message.')

            try:
                send = await bot.wait_for('message', check=confirm, timeout=5.0)
            except asyncio.TimeoutError:
                return await message.channel.send('Timed out.')
            if send == "Confirm":
                await channel.send(embed=embed)

        else:
            await ctx.send(get_string("BOT_PERMISSION_ERROR"))

    @commands.command(name="ban-confessions")
    async def cmd_ban_confessions(self, ctx, *, message=""):
        # TODO: convert everything to docstrings.
        """Bans a user from using confessions. A reason is not yet supported, but might be implemented soon:tm:.
        """
        if verify_user(ctx, "admin"):
            if message is None:
                await ctx.send(get_string("COMMAND_EMPTY_USER_ID"))
            else:
                add_ban(int(ctx.message.author))
                await ctx.send(":white_check_mark:")
        else:
            await ctx.send(get_string("CMD_PERMISSION_ERROR"))

    @commands.command(name="unban-confessions", brief="Unbans a user from confessions. ")
    async def cmd_unban_confessions(self, ctx, *, message=""):
        if verify_user(ctx, "admin"):
            if message is None:
                await ctx.send(
                    "Please provide the user ID. To grab someone's ID, enable developer options in appearance, "
                    "right click their username and click ''Copy ID''")
            else:
                try:
                    rm_ban(int(message))
                except ValueError:
                    await ctx.send("Invalid ID. ID must be an integer. ")
                await ctx.send("User unbanned from sending confessions. ")
                print(f"{ctx.message.author} just unbanned {bot.get_user(int(message))}. ",
                      file=open("permissionLog.txt", "a"))
        else:
            await ctx.send(get_string("CMD_PERMISSION_ERROR"))

    @commands.command(name="confession-bans", brief="Lists all banned confession users. ")
    async def cmd_confession_bans(self, ctx):
        embed = discord.Embed(description="Getting bans, please wait.")
        message = ctx.send(embed=embed)
        if verify_user(ctx, "admin"):
            for each in get_bans():
                embed += "\n {0}".format(bot.get_user(each))
                message.edit(embed=embed)
        else:
            await ctx.send(get_string("CMD_PERMISSION_ERROR"))


def setup(bot):
    bot.add_cog(Confess(bot))
